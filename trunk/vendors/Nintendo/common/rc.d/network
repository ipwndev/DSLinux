#!/bin/sh

[ -e /etc/rc.defaults ] && . /etc/rc.defaults
[ -e /etc/rc.conf ] && . /etc/rc.conf

case "$1" in
	start)
		if [ -n "$essid" ]
		then
			iwconfig_args=""

			echo "Configuring wireless interface:"
			echo "ESSID:    $essid"
			iwconfig_args="$iwconfig_args essid $essid"
			
			if [ -n "$channel" ]
			then 
				echo "Channel:  $channel"
				iwconfig_args="$iwconfig_args channel $channel"
			fi

			if [ -n "$wepkey" ]
			then
				echo "Setting wepkey."
				iwconfig_args="$iwconfig_args key $wepkey"
			fi

			iwconfig nds $iwconfig_args
			sleep 1

		else
			echo "Not configuring network:"
			echo "No ESSID defined. See /etc/rc.defaults!"
			exit 1
		fi

		ifconfig nds down
		sleep 1

		if [ "$use_dhcp" = "YES" ]
		then
			echo "Configuring network via DHCP."
			# We have very little RAM, so use 'exec' to avoid
			# forking a new process for the dhcp client. This is
			# the last command to run anyway if using dhcp.
			exec udhcpc -n -q -i nds
			### NOT REACHED ###
		elif [ -n "$ip" ] && [ -n "$gateway" ]
		then

			ifconfig_args=""
			route_args=""

			echo "Configuring network:"
			echo "IP:        $ip"
			echo "Gateway:   $gateway"
			ifconfig_args="$ifconfig_args $ip"

			if [ -n "$netmask" ]
				echo "Netmask:   $netmask"
				ifconfig_args="$ifconfig_args netmask $netmask"
			fi
			if [ -n "$broadcast" ]
				echo "Broadcast: $broadcast"
				ifconfig_args="$ifconfig_args broadcast $broadcast"
			fi

			ifconfig nds $ifconfig_args up
			sleep 1
			route add default gw $gateway
		else
			echo "Not configuring network:"
			echo "No static configuration found and DHCP is disabled."
			exit 1
		fi

		exit 0
	;;
	stop)
		echo "Stopping network."
		ifconfig nds down
		kill `pidof udhcpc` 2> /dev/null
	;;	
	restart)
		$0 stop
		$0 start
	;;
	*)
		echo "Usage: $0 <start|stop|restart>"
		exit 1
	;;
esac

