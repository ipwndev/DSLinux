
# set defaults
[ -e /etc/rc.defaults ] && . /etc/rc.defaults

# include overrides
if [ -e /etc/rc.conf ]
then
	. /etc/rc.conf
else
	echo "The file /etc/rc.conf does not exist on your system,"
	echo "so the default configuration will be used."
	echo "The file /etc/rc.defaults contains instructions on how"
	echo "to create /etc/rc.conf to customise your dslinux installation."
fi

PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
export PATH

# create /etc/passwd if it doesn't exist
if [ ! -f /etc/passwd ]
then
	echo "Creating default /etc/passwd"
	echo "root:xxSVJVBe8UDn2:0:0:Tim Bisley:/home:/bin/sh" > /etc/passwd
	echo "bin:x:1:1:bin:/bin:" >> /etc/passwd
	echo "daemon:x:2:2:daemon:/sbin:" >> /etc/passwd
	echo "nobody:x:99:99:Nobody:/:" >> /etc/passwd
fi

# setup networking
if [ "$enable_network_on_boot" = "YES" ]
then
	if /etc/rc.d/network start
	then
		__network_up="YES"
	else
		__network_up="NO"
	fi
else
	echo "Not configuring network:"
	echo "enable_network_on_boot is set to \"$enable_network_on_boot\""
	echo "To configure wireless edit /etc/rc.conf or run 'wnc'."
	__network_up="NO"
fi

# start inetd if configured
if [ "$start_inetd" = "YES" ]
then
	if [ "$__network_up" = "YES" ]
	then
		/etc/rc.d/inetd start
	else
		echo "Not starting inetd: network is down"
	fi
fi

# set hostname
hostname $hostname

# set up /etc/hosts so networking tools will work
echo "127.0.0.1 $hostname" > /etc/hosts

# if we have extra RAM, enable 2 extra terminals and gpm
exec 0</proc/meminfo
read line
exec 0</dev/null
set -- $line
if [ $2 -gt 4000 ]
then
	/usr/bin/agetty -n -l /bin/autologin 38400 tty2 linux &
	/usr/bin/agetty -n -l /bin/autologin 38400 tty3 linux &
	[ -x /usr/bin/gpm ] && /usr/bin/gpm -m /dev/mouse0 -t ps2 &
fi

# show firmware version if configured
[ "$show_firmware_version" = "YES" ] && fwver

# run local startup script if it exists
[ -e /etc/rc.local ] && . /etc/rc.local

# setup nano-X
if [ "$start_nanox" = "YES" ]
then
	fbset -depth 16 -n
	ifconfig lo up
fi

# setup PIXIL
if [ "$start_pixil" = "YES" ]
then
	/usr/pixil/nxstart.sh&
fi

# this is here so that we will get a login prompt in any case
exit 0
